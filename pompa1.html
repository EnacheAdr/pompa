<script>
  const firebaseConfig = {
    databaseURL: "https://pompa-8dfcb-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const dbRef = db.ref();

  dbRef.once("value", (snapshot) => {
    const data = snapshot.val();
    const timestamps = Object.keys(data).sort(); // SORTARE CRONOLOGICĂ
    const healthValues = [];
    const flowValues = [];
    const currentValues = [];

    timestamps.forEach((timestamp) => {
      const entry = data[timestamp];
      if (entry && typeof entry.health === 'number') {
        healthValues.push(entry.health);
        flowValues.push(entry.flow || 0);
        currentValues.push(entry.current || 0);
      }
    });

    const labels = healthValues.map((_, i) => `Citirea ${i + 1}`);
    const minValue = Math.min(...healthValues);
    const minIndex = healthValues.indexOf(minValue);

    const timeUsedSeconds = timestamps.length * 30;
    const performanceDropSeconds = ((100 - minValue) / 100) * 500 * 3600;
    const remainingSeconds = Math.max(0, 500 * 3600 - timeUsedSeconds - performanceDropSeconds);

    const hours = Math.floor(remainingSeconds / 3600);
    const minutes = Math.floor((remainingSeconds % 3600) / 60);
    const seconds = Math.floor(remainingSeconds % 60);

    document.getElementById("timeRemaining").textContent = `Timp estimat de viață rămas al pompei: ${hours} ore, ${minutes} minute, ${seconds} secunde`;
    document.getElementById("currentHealth").textContent = `${minValue.toFixed(2)}%`;
    const fill = document.getElementById("healthFill");
    fill.textContent = `${hours} ore, ${minutes} minute, ${seconds} secunde`;

    const label = document.getElementById("healthLabel");
    const alert = document.getElementById("healthAlert");

    if (remainingSeconds >= 300 * 3600) {
      fill.className = "health-bar-fill green";
      label.style.backgroundColor = '#2ecc71';
      label.style.color = '#000';
      alert.className = "alert green-alert";
      alert.textContent = "✅ Pompa funcționează în parametri optimi. Nu sunt semne de uzură semnificativă.";
    } else if (remainingSeconds >= 150 * 3600) {
      fill.className = "health-bar-fill yellow";
      label.style.backgroundColor = '#f1c40f';
      label.style.color = '#000';
      alert.className = "alert yellow-alert";
      alert.textContent = "⚠ Atenție: semne moderate de scădere a performanței. Se recomandă o verificare tehnică.";
    } else {
      fill.className = "health-bar-fill red";
      label.style.backgroundColor = '#e74c3c';
      label.style.color = '#fff';
      alert.className = "alert red-alert";
      alert.textContent = "❗Avertisment: performanță critică. Necesită întreținere imediată!";
    }

    const ctx = document.getElementById('healthChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Sănătate pompa (%)',
          data: healthValues,
          fill: false,
          borderColor: '#00ffe6',
          backgroundColor: function(ctx) {
            return ctx.dataIndex === minIndex ? '#ff0000' : '#00ffe6';
          },
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const i = context.dataIndex;
                return `Sănătate: ${healthValues[i]}% | Debit: ${flowValues[i]} L/h | Curent: ${currentValues[i]} mA`;
              }
            }
          },
          legend: {
            labels: {
              generateLabels: function() {
                return [{
                  text: '🔴 Sănătate/performanță actuală a pompei',
                  fillStyle: '#ff0000',
                  strokeStyle: '#ff0000',
                  lineWidth: 1
                }];
              }
            }
          }
        },
        scales: {
          y: {
            min: 60,
            max: 100,
            ticks: { color: '#fff' },
            title: {
              display: true,
              text: 'Sănătate/performanță (%)',
              color: '#fff'
            }
          },
          x: {
            ticks: { color: '#fff', maxRotation: 90, minRotation: 90 }
          }
        }
      }
    });
  });
</script>
